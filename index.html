<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<title>Bin There, Done That — Demo</title>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsbarcode/3.11.5/JsBarcode.all.min.js"></script>

<style>
  :root{
    --green-1:#2ecc71;
    --green-2:#27ae60;
    --teal:#16a085;
    --muted:#e8f8f5;
    --card-radius:12px;
    --base-font:15px;
  }

  /* Reset & base */
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    font-family: "Segoe UI", Roboto, Arial, sans-serif;
    margin:0;
    background: linear-gradient(180deg,#f6fff7 0%, #e8fff0 100%);
    color:#203030;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    font-size:var(--base-font);
    line-height:1.25;
  }

  /* App shell */
  .app {
    max-width:1100px;
    margin:0 auto;
    min-height:100vh;
    display:flex;
    flex-direction:column;
  }

  header{
    background: rgba(255,255,255,0.98);
    padding:0.6rem 1rem;
    display:flex;
    gap:0.6rem;
    align-items:center;
    justify-content:space-between;
    position:sticky;
    top:0;
    z-index:40;
    box-shadow:0 4px 10px rgba(0,0,0,0.06);
    border-bottom-left-radius:10px;
    border-bottom-right-radius:10px;
  }

  .brand {
    display:flex;
    gap:0.6rem;
    align-items:center;
  }
  .brand .logo{
    width:36px;height:36px;border-radius:8px;background:linear-gradient(135deg,var(--green-1),var(--green-2));
    display:flex;align-items:center;justify-content:center;color:white;font-weight:700;
    box-shadow:0 4px 12px rgba(39,174,96,0.18);
    font-size:1rem;
  }
  .brand h1{font-size:1rem;margin:0;color:var(--green-2);font-weight:700}
  .nav {
    display:flex;
    gap:0.4rem;
  }
  .nav button {
    border:none;background:transparent;padding:0.45rem 0.6rem;border-radius:8px;font-weight:600;
    color:var(--green-2);cursor:pointer;font-size:0.95rem;
  }
  .nav button.active, .nav button:focus{background:rgba(39,174,96,0.08)}

  /* container */
  .container{padding:0.9rem;flex:1;display:flex;flex-direction:column;gap:0.9rem}

  /* points pill */
  .points-pill{
    background:linear-gradient(90deg,var(--green-1),var(--green-2));
    color:white;padding:0.6rem 0.9rem;border-radius:999px;display:inline-block;font-weight:700;
    box-shadow:0 6px 18px rgba(46,204,113,0.12);
    font-size:0.95rem;
  }

  /* pages */
  .page{display:none}
  .page.active{display:block}

  /* cards compact */
  .card{
    background:white;border-radius:var(--card-radius);padding:0.8rem;box-shadow:0 8px 20px rgba(0,0,0,0.06);
    display:block;
  }
  h2{font-size:1.05rem;margin:0 0 0.5rem 0;color:var(--teal)}
  p.small{font-size:0.92rem;color:#39524f;margin:0.2rem 0}

  /* kiosk list compact */
  .kiosk-grid{display:grid;grid-template-columns:1fr 1fr;gap:0.5rem}
  .kiosk-item{display:flex;flex-direction:column;gap:0.35rem;padding:0.6rem;border-left:4px solid var(--green-2);}
  .kiosk-item h3{margin:0;font-size:0.98rem;color:var(--green-2)}
  .kiosk-item p{margin:0;font-size:0.86rem;color:#406462}
  .kiosk-actions{display:flex;gap:0.4rem;align-items:center;justify-content:space-between}
  .kiosk-actions button{flex:1;padding:0.45rem 0.5rem;border-radius:8px;border:none;background:linear-gradient(90deg,var(--green-1),var(--green-2));color:white;font-weight:700;font-size:0.9rem}

  /* scan area */
  .scan-wrap{display:flex;flex-direction:column;gap:0.6rem;align-items:center}
  .video-wrap{position:relative;width:100%;max-width:420px;height:280px;background:#000;border-radius:10px;overflow:hidden;display:flex;align-items:center;justify-content:center}
  .video-wrap.scaling{transform:scale(1.15);transition:transform 220ms cubic-bezier(.2,.9,.3,1)}
  video#preview{width:100%;height:100%;object-fit:cover;-webkit-transform:translateZ(0)}
  canvas#overlay{position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none}

  .scan-controls{display:flex;gap:0.5rem;width:100%;max-width:420px}
  .scan-controls button{flex:1;padding:0.6rem;border-radius:10px;border:none;background:#fff;box-shadow:0 4px 12px rgba(0,0,0,0.06);font-weight:700;color:var(--green-2)}

  .scan-result{width:100%;max-width:420px;padding:0.6rem;border-radius:10px;background:var(--muted);font-weight:600;color:#155;min-height:48px}

  /* manual code compact */
  .manual-grid{display:flex;gap:0.5rem}
  .manual-grid select,.manual-grid input{flex:1;padding:0.5rem;border-radius:8px;border:1px solid #ddd;font-size:0.95rem}

  /* vouchers */
  .voucher-grid{display:grid;grid-template-columns:1fr;gap:0.6rem}
  @media(min-width:700px){ .kiosk-grid{grid-template-columns:repeat(2,1fr)} .voucher-grid{grid-template-columns:repeat(2,1fr)} .nav{gap:0.6rem} }

  .voucher-card{display:flex;flex-direction:column;gap:0.5rem;padding:0.8rem;border:2px solid rgba(39,174,96,0.06);border-radius:10px;background:linear-gradient(180deg,#fbfff9,#f4fff6)}
  .voucher-title{font-weight:800;color:var(--green-2);font-size:1rem}
  .voucher-cost{font-weight:800;color:var(--teal);font-size:1.05rem}
  .voucher-actions{display:flex;gap:0.5rem}
  .voucher-actions button{flex:1;padding:0.55rem;border-radius:8px;border:none;background:linear-gradient(90deg,var(--green-1),var(--green-2));color:white;font-weight:800}

  /* barcode area inside card */
  .barcode-area{display:flex;flex-direction:column;gap:0.5rem;padding:0.5rem;border-radius:8px;background:white;align-items:center}
  svg.barcode{max-width:100%;height:80px}

  /* leaderboard */
  .leaderboard-table{width:100%;border-collapse:collapse}
  .leaderboard-table th{background:linear-gradient(90deg,var(--green-1),var(--green-2));color:white;padding:0.55rem;text-align:left;font-weight:700;font-size:0.95rem}
  .leaderboard-table td{padding:0.55rem;border-bottom:1px solid #eef}

  /* admin collapsed */
  .admin-toggle{background:transparent;border:1px solid #eee;padding:0.3rem 0.5rem;border-radius:8px;color:#999;font-size:0.9rem}

  /* small helpers */
  .muted{color:#5f7b77;font-size:0.88rem}
  .center{text-align:center}
  .hidden{display:none}
  .success{background:#2ecc71;color:#fff;padding:0.45rem;border-radius:8px;font-weight:700;text-align:center}
  .error{background:#ff6b6b;color:white;padding:0.45rem;border-radius:8px;text-align:center}

  /* small footprint for footer */
  footer{font-size:0.82rem;color:#567;opacity:0.9;padding:0.6rem 1rem;text-align:center}
</style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <div class="logo">BT</div>
        <div>
          <h1>Bin There, Done That</h1>
          <div style="font-size:0.82rem;color:#2f6d61">Recycling rewards demo</div>
        </div>
      </div>

      <nav class="nav" aria-label="Main navigation">
        <button data-page="home" class="active">Home</button>
        <button data-page="find">Find Kiosks</button>
        <button data-page="scan">Scan QR</button>
        <button data-page="redeem">Redeem</button>
        <button data-page="leaderboard">Leaderboard</button>
      </nav>
    </header>

    <main class="container">
      <!-- Points display -->
      <div class="card" style="display:flex;justify-content:space-between;align-items:center;">
        <div>
          <div style="font-weight:800;color:var(--green-2);font-size:0.95rem">Welcome back!</div>
          <div class="muted" style="margin-top:4px">Earn points by scanning kiosks.</div>
        </div>
        <div>
          <div class="points-pill">Your Points: <span id="userPoints">0</span></div>
        </div>
      </div>

      <!-- HOME PAGE -->
      <section id="home" class="page active">
        <div class="card">
          <h2>Our Mission</h2>
          <p class="small">Make recycling effortless, rewarding and competitive for communities across Singapore. Scan at kiosks to earn points and redeem vouchers.</p>
        </div>

        <div class="card" style="margin-top:0.6rem">
          <h2 style="display:flex;justify-content:space-between;align-items:center">
            <span>Find Our Kiosks</span>
            <span class="muted" style="font-weight:700">Tap a kiosk → Directions</span>
          </h2>

          <div class="kiosk-grid" style="margin-top:0.6rem">
            <!-- Kiosk items will be injected by JS -->
            <div class="kiosk-item card" data-lat="1.3505" data-lon="103.8485" data-id="J8">
              <h3>Junction 8</h3>
              <p>9 Bishan Pl, Singapore 579837</p>
              <div class="kiosk-actions">
                <button onclick="openDirectionsFromEl(this)">Get Directions</button>
              </div>
            </div>

            <div class="kiosk-item card" data-lat="1.4294" data-lon="103.8358" data-id="NP">
              <h3>Northpoint City</h3>
              <p>930 Yishun Ave 2, Singapore 769098</p>
              <div class="kiosk-actions">
                <button onclick="openDirectionsFromEl(this)">Get Directions</button>
              </div>
            </div>

            <div class="kiosk-item card" data-lat="1.4064" data-lon="103.9022" data-id="WP">
              <h3>Waterway Point</h3>
              <p>83 Punggol Central, Singapore 828761</p>
              <div class="kiosk-actions">
                <button onclick="openDirectionsFromEl(this)">Get Directions</button>
              </div>
            </div>

            <div class="kiosk-item card" data-lat="1.3014" data-lon="103.9053" data-id="PP">
              <h3>Parkway Parade</h3>
              <p>80 Marine Parade Rd, Singapore 449269</p>
              <div class="kiosk-actions">
                <button onclick="openDirectionsFromEl(this)">Get Directions</button>
              </div>
            </div>

            <div class="kiosk-item card" data-lat="1.3340" data-lon="103.7426" data-id="WG">
              <h3>Westgate</h3>
              <p>3 Gateway Dr, Singapore 608532</p>
              <div class="kiosk-actions">
                <button onclick="openDirectionsFromEl(this)">Get Directions</button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- FIND PAGE (duplicate content but separate page for reliability) -->
      <section id="find" class="page">
        <div class="card">
          <h2>Find Our Kiosks</h2>
          <p class="small">Tap 'Get Directions' to open Google Maps (works on mobile & desktop).</p>
          <div style="height:8px"></div>

          <div class="kiosk-grid">
            <!-- replicate the same list to keep pages independent -->
            <div class="kiosk-item card" data-lat="1.3505" data-lon="103.8485" data-id="J8">
              <h3>Junction 8</h3>
              <p>9 Bishan Pl</p>
              <div class="kiosk-actions"><button onclick="openDirectionsFromEl(this)">Get Directions</button></div>
            </div>

            <div class="kiosk-item card" data-lat="1.4294" data-lon="103.8358" data-id="NP">
              <h3>Northpoint City</h3>
              <p>930 Yishun Ave 2</p>
              <div class="kiosk-actions"><button onclick="openDirectionsFromEl(this)">Get Directions</button></div>
            </div>

            <div class="kiosk-item card" data-lat="1.4064" data-lon="103.9022" data-id="WP">
              <h3>Waterway Point</h3>
              <p>83 Punggol Central</p>
              <div class="kiosk-actions"><button onclick="openDirectionsFromEl(this)">Get Directions</button></div>
            </div>

            <div class="kiosk-item card" data-lat="1.3014" data-lon="103.9053" data-id="PP">
              <h3>Parkway Parade</h3>
              <p>80 Marine Parade Rd</p>
              <div class="kiosk-actions"><button onclick="openDirectionsFromEl(this)">Get Directions</button></div>
            </div>

            <div class="kiosk-item card" data-lat="1.3340" data-lon="103.7426" data-id="WG">
              <h3>Westgate</h3>
              <p>3 Gateway Dr</p>
              <div class="kiosk-actions"><button onclick="openDirectionsFromEl(this)">Get Directions</button></div>
            </div>
          </div>
        </div>
      </section>

      <!-- SCAN PAGE -->
      <section id="scan" class="page">
        <div class="card">
          <h2>Scan QR Code</h2>
          <p class="small">Allow camera access. Hold the camera steady and align the QR in the center. A green box appears when a QR is detected.</p>

          <div class="scan-wrap" style="margin-top:0.6rem">
            <div id="videoWrap" class="video-wrap">
              <video id="preview" autoplay muted playsinline></video>
              <canvas id="overlay"></canvas>
            </div>

            <div style="display:flex;gap:0.5rem;width:100%;max-width:420px">
              <button id="btnStart" onclick="startScanner()">Start</button>
              <button id="btnStop" onclick="stopScanner()" style="background:#fff;border:1px solid #eee;color:var(--green-2)">Stop</button>
            </div>

            <div id="scanResult" class="scan-result muted">No scan yet.</div>
          </div>
        </div>

        <!-- manual entry short -->
        <div class="card" style="margin-top:0.6rem">
          <h2>Enter Code Manually</h2>
          <p class="small">Short format accepted: <strong>J8-500</strong> (locationID-points). Full format also accepted.</p>
          <div style="display:flex;gap:0.5rem;flex-direction:column;margin-top:0.4rem">
            <div style="display:flex;gap:0.5rem">
              <input id="manualShort" type="text" placeholder="e.g., J8-500" style="flex:1;padding:0.6rem;border-radius:8px;border:1px solid #ddd" />
              <button onclick="processManualShort()" style="padding:0.55rem;border-radius:8px;border:none;background:linear-gradient(90deg,var(--green-1),var(--green-2));color:white;font-weight:800">Submit</button>
            </div>
            <div class="muted">You can also paste a full QR code text like <code>BTD-J8-1630000000000-500</code></div>
          </div>
        </div>
      </section>

      <!-- REDEEM PAGE -->
      <section id="redeem" class="page">
        <div class="card">
          <h2>Redeem Vouchers</h2>
          <p class="small">Select voucher — confirm to redeem. The barcode will appear below the voucher inside the card.</p>

          <div class="voucher-grid" style="margin-top:0.6rem">
            <div class="voucher-card card" data-company="ABC" data-cost="100">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div>
                  <div class="voucher-title">CompanyABC</div>
                  <div class="muted">10% off min $10 nett</div>
                </div>
                <div class="voucher-cost">100 pts</div>
              </div>

              <div class="voucher-actions" style="margin-top:0.4rem">
                <button onclick="redeemVoucher(this)" data-company="ABC" data-cost="100">Redeem</button>
              </div>

              <!-- Barcode area will appear here -->
              <div class="barcode-target"></div>
            </div>

            <div class="voucher-card card" data-company="DEF" data-cost="500">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div><div class="voucher-title">CompanyDEF</div><div class="muted">$3 discount</div></div>
                <div class="voucher-cost">500 pts</div>
              </div>
              <div class="voucher-actions" style="margin-top:0.4rem"><button onclick="redeemVoucher(this)" data-company="DEF" data-cost="500">Redeem</button></div>
              <div class="barcode-target"></div>
            </div>

            <div class="voucher-card card" data-company="GHI" data-cost="1000">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div><div class="voucher-title">CompanyGHI</div><div class="muted">Free item</div></div>
                <div class="voucher-cost">1000 pts</div>
              </div>
              <div class="voucher-actions" style="margin-top:0.4rem"><button onclick="redeemVoucher(this)" data-company="GHI" data-cost="1000">Redeem</button></div>
              <div class="barcode-target"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- LEADERBOARD -->
      <section id="leaderboard" class="page">
        <div class="card">
          <h2>Kiosk Leaderboard</h2>
          <p class="small">Rankings based on total recycling contributions (demo random values persisted in cookies).</p>

          <table class="leaderboard-table" style="margin-top:0.6rem">
            <thead><tr><th>Rank</th><th>Kiosk</th><th>Total Points</th></tr></thead>
            <tbody id="leaderboardBody"></tbody>
          </table>
        </div>
      </section>
    </main>

    <footer>Demo — Static single-file app. Camera required for scanning (HTTPS recommended).</footer>
  </div>

<script>
/* --------------------
   Utility & cookie helpers
   -------------------- */
function setCookie(name,value,days=365){
  const d=new Date(); d.setTime(d.getTime()+days*24*60*60*1000);
  document.cookie = name+"="+encodeURIComponent(value)+";expires="+d.toUTCString()+";path=/";
}
function getCookie(name){
  const v=document.cookie.split(';').map(s=>s.trim()).find(s=>s.startsWith(name+"="));
  return v?decodeURIComponent(v.split('=')[1]):null;
}

/* --------------------
   Basic app state: points & leaderboard
   -------------------- */
const locations = {
  'J8': {name:'Junction 8'},
  'NP': {name:'Northpoint City'},
  'WP': {name:'Waterway Point'},
  'PP': {name:'Parkway Parade'},
  'WG': {name:'Westgate'}
};

function getUserPoints(){ return parseInt(getCookie('userPoints'))||0; }
function setUserPoints(p){ setCookie('userPoints', String(p), 365); updatePointsDisplay(); }
function updatePointsDisplay(){ document.getElementById('userPoints').textContent = getUserPoints(); }

/* init leaderboard with random demo values if none */
function initLeaderboard(){
  let data = getCookie('leaderboardData');
  if(!data){
    const d={
      'J8': Math.floor(Math.random()*5000)+15000,
      'NP': Math.floor(Math.random()*5000)+10000,
      'WP': Math.floor(Math.random()*5000)+12000,
      'PP': Math.floor(Math.random()*5000)+8000,
      'WG': Math.floor(Math.random()*5000)+13000
    };
    setCookie('leaderboardData', JSON.stringify(d), 365);
    return d;
  }
  try { return JSON.parse(data); } catch(e) { return initLeaderboard(); }
}

function displayLeaderboard(){
  const data = initLeaderboard();
  const sorted = Object.entries(data).sort((a,b)=>b[1]-a[1]);
  const tbody = document.getElementById('leaderboardBody'); tbody.innerHTML='';
  sorted.forEach((e,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td style="font-weight:800">#${i+1}</td><td>${locations[e[0]].name}</td><td>${e[1].toLocaleString()} pts</td>`;
    tbody.appendChild(tr);
  });
}

/* --------------------
   Navigation (show/hide pages)
   -------------------- */
document.querySelectorAll('.nav button').forEach(b=>{
  b.addEventListener('click', e=>{
    document.querySelectorAll('.nav button').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');

    const page = b.getAttribute('data-page');
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    document.getElementById(page).classList.add('active');

    // start/stop scanner when appropriate
    if(page === 'scan'){ /* nothing automatic, user taps start */ }
    if(page === 'leaderboard') displayLeaderboard();
  });
});

/* --------------------
   GET DIRECTIONS (works on mobile & desktop)
   -------------------- */
function openDirectionsFromEl(btn){
  const item = btn.closest('.kiosk-item');
  const lat = item.getAttribute('data-lat');
  const lon = item.getAttribute('data-lon');
  const name = item.querySelector('h3').textContent || 'kiosk';
  if(!lat||!lon) return alert('Coordinates not available');
  const url = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(lat+','+lon)}&destination_place_id=&travelmode=walking`;
  window.open(url, '_blank');
}

/* --------------------
   QR Scanner using getUserMedia + jsQR
   -------------------- */
let stream = null;
let scanning = false;
const video = document.getElementById('preview');
const overlay = document.getElementById('overlay');
const ctx = overlay.getContext('2d');
const videoWrap = document.getElementById('videoWrap');
let scanInterval = null;

function startScanner(){
  if(scanning) return;
  navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}}).then(s=>{
    stream = s;
    video.srcObject = stream;
    video.play();
    scanning = true;
    overlay.width = video.offsetWidth;
    overlay.height = video.offsetHeight;
    document.getElementById('scanResult').textContent = 'Searching for QR...';
    // start scanning loop
    scanInterval = requestAnimationFrame(tick);
  }).catch(err=>{
    console.error(err);
    document.getElementById('scanResult').innerHTML = '<div class="error">Camera inaccessible. Use manual input.</div>';
  });
}

function stopScanner(){
  if(!scanning) return;
  if(scanInterval) cancelAnimationFrame(scanInterval);
  scanInterval = null;
  scanning = false;
  if(stream){
    stream.getTracks().forEach(t=>t.stop());
    stream = null;
  }
  ctx.clearRect(0,0,overlay.width,overlay.height);
  video.srcObject = null;
  document.getElementById('scanResult').textContent = 'Scanner stopped.';
  videoWrap.classList.remove('scaling');
}

/* frame loop */
function tick(){
  if(!scanning) return;
  if(video.readyState === video.HAVE_ENOUGH_DATA){
    // keep canvas size matching video size
    overlay.width = video.videoWidth;
    overlay.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, overlay.width, overlay.height);

    try {
      const imageData = ctx.getImageData(0,0,overlay.width, overlay.height);
      const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "attemptBoth" });
      if(code){
        // draw green bounding polygon
        drawLine(code.location.topLeftCorner, code.location.topRightCorner);
        drawLine(code.location.topRightCorner, code.location.bottomRightCorner);
        drawLine(code.location.bottomRightCorner, code.location.bottomLeftCorner);
        drawLine(code.location.bottomLeftCorner, code.location.topLeftCorner);

        // visual auto-zoom effect
        videoWrap.classList.add('scaling');

        // short debounce — process once then stop briefly to avoid duplicates
        document.getElementById('scanResult').textContent = 'QR detected — processing...';
        processQRCode(code.data);
        // stop scanning for 1.2s then resume (prevent immediate duplicates)
        setTimeout(()=>{ if(scanning) { ctx.clearRect(0,0,overlay.width,overlay.height); videoWrap.classList.remove('scaling'); document.getElementById('scanResult').textContent = 'Searching for QR...'; } }, 1200);
        // continue scanning but to avoid double-processing we will wait next frames
      } else {
        // no QR found — clear overlay and remove scaling
        ctx.clearRect(0,0,overlay.width,overlay.height);
        videoWrap.classList.remove('scaling');
      }
    } catch(e){
      console.error('scan error', e);
    }
  }
  scanInterval = requestAnimationFrame(tick);
}

function drawLine(a,b){
  ctx.strokeStyle = 'rgba(72,187,120,0.95)';
  ctx.lineWidth = Math.max(4, (overlay.width / 320));
  ctx.beginPath();
  ctx.moveTo(a.x, a.y);
  ctx.lineTo(b.x, b.y);
  ctx.stroke();
}

/* --------------------
   Process QR / manual code (support short manual codes)
   -------------------- */
function processQRCode(code){
  // Accept and handle any QR contents.
  // Known good format: BTD-LOCATION-TIMESTAMP-POINTS
  // Also accept short manual format like: J8-500 (locationId-points)
  console.log('QR content:', code);

  // sometimes code might contain whitespace/newlines; clean it
  const raw = code.trim();

  // If short form (e.g., J8-500)
  const shortMatch = raw.match(/^([A-Z]{1,3})[-_]?(\d{1,5})$/i);
  if(shortMatch){
    const loc = shortMatch[1].toUpperCase();
    const pts = parseInt(shortMatch[2],10);
    const ts = Date.now();
    handleScanResult(loc, ts, pts);
    return;
  }

  // If full BTD form
  const parts = raw.split('-');
  if(parts.length === 4 && parts[0].toUpperCase() === 'BTD'){
    const loc = parts[1];
    const ts = parts[2];
    const pts = parseInt(parts[3],10);
    handleScanResult(loc, ts, pts);
    return;
  }

  // unknown format: show as scanned but not awarding points
  document.getElementById('scanResult').innerHTML = `<div class="error">Unrecognized QR: <br><small>${escapeHtml(raw)}</small></div>`;
}

function handleScanResult(locationId, timestamp, points){
  if(!locations[locationId]) {
    document.getElementById('scanResult').innerHTML = `<div class="error">Invalid location: ${escapeHtml(locationId)}</div>`;
    return;
  }
  // award points
  const cur = getUserPoints();
  setUserPoints(cur + (isNaN(points)?0:points));
  document.getElementById('scanResult').innerHTML = `<div class="success">Success! ${locations[locationId].name} — +${points} pts. Total: ${getUserPoints()} pts</div>`;
}

/* helper escape */
function escapeHtml(s){ return (''+s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* --------------------
   Manual short processing (from input box)
   -------------------- */
function processManualShort(){
  const v = document.getElementById('manualShort').value.trim();
  if(!v) { alert('Please enter code like J8-500'); return; }
  processQRCode(v);
}

/* --------------------
   REDEEM FLOW: confirm, prevent double-click, show barcode in same card, copy & download
   -------------------- */
function redeemVoucher(btn){
  const company = btn.getAttribute('data-company');
  const cost = parseInt(btn.getAttribute('data-cost'),10);

  const current = getUserPoints();
  if(current < cost){
    alert('Insufficient points!');
    return;
  }

  if(!confirm(`Confirm redeem ${company} for ${cost} points?`)) return;

  // prevent double clicks
  btn.disabled = true;
  btn.style.opacity = 0.6;

  // deduct points immediately
  setUserPoints(current - cost);

  // create voucher id and barcode
  const barcodeId = generateBarcodeId(company);
  // render inside the same voucher card's barcode-target
  const card = btn.closest('.voucher-card');
  const target = card.querySelector('.barcode-target');
  target.innerHTML = ''; // clear existing

  const container = document.createElement('div');
  container.className = 'barcode-area';
  container.innerHTML = `
    <div style="font-weight:800;color:#2f6d61">Voucher Redeemed!</div>
    <div style="font-size:0.9rem" class="muted">Show this barcode at the store</div>
    <svg class="barcode" id="svg_${barcodeId}"></svg>
    <div style="display:flex;gap:0.4rem;width:100%">
      <input type="text" readonly value="${barcodeId}" id="code_${barcodeId}" style="flex:1;padding:0.45rem;border-radius:6px;border:1px solid #eee" />
      <button style="padding:0.45rem;border-radius:6px;border:none;background:#27ae60;color:white" onclick="copyBarcode('${barcodeId}')">Copy</button>
      <button style="padding:0.45rem;border-radius:6px;border:none;background:#16a085;color:white" onclick="downloadBarcode('${barcodeId}')">Download</button>
    </div>
  `;
  target.appendChild(container);

  // render barcode using JsBarcode
  const svgEl = document.getElementById(`svg_${barcodeId}`);
  JsBarcode(svgEl, barcodeId, { format: "CODE128", width: 2, height: 60, displayValue: true });

  // re-enable button after short delay to avoid accidental double redeeming
  setTimeout(()=>{
    btn.disabled = false;
    btn.style.opacity = 1;
  }, 1200);
}

function generateBarcodeId(company){
  const random = Math.floor(Math.random()*1e9).toString().padStart(9,'0');
  let prefix = '';
  if(company === 'ABC') prefix='ABC10';
  if(company === 'DEF') prefix='DEF3';
  if(company === 'GHI') prefix='GHIFREE';
  return prefix + random;
}

function copyBarcode(id){
  const el = document.getElementById('code_'+id);
  if(!el) return;
  el.select();
  try{
    document.execCommand('copy');
    alert('Barcode copied to clipboard');
  } catch(e){
    // fallback
    navigator.clipboard?.writeText(el.value).then(()=>alert('Copied'), ()=>alert('Copy failed'));
  }
}

/* convert SVG to PNG and trigger download */
function downloadBarcode(id){
  const svg = document.getElementById('svg_'+id);
  if(!svg) return alert('Barcode not found');
  const svgData = new XMLSerializer().serializeToString(svg);
  const canvas = document.createElement('canvas');
  const width = 600; const height = 200;
  canvas.width = width; canvas.height = height;
  const ctx2 = canvas.getContext('2d');

  const img = new Image();
  const svgBlob = new Blob([svgData], {type:'image/svg+xml;charset=utf-8'});
  const url = URL.createObjectURL(svgBlob);
  img.onload = function(){
    // white background
    ctx2.fillStyle = '#fff';
    ctx2.fillRect(0,0,canvas.width,canvas.height);
    // draw centered
    const scale = Math.min(canvas.width / img.width, canvas.height / img.height);
    const w = img.width * scale; const h = img.height * scale;
    ctx2.drawImage(img, (canvas.width-w)/2, (canvas.height-h)/2, w, h);
    URL.revokeObjectURL(url);
    const png = canvas.toDataURL('image/png');
    const a = document.createElement('a');
    a.href = png;
    a.download = id + '.png';
    document.body.appendChild(a);
    a.click();
    a.remove();
  };
  img.onerror = function(){ alert('Failed to generate image'); URL.revokeObjectURL(url) };
  img.src = url;
}

/* --------------------
   Init on load
   -------------------- */
updatePointsDisplay();
displayLeaderboard();

/* ensure overlay canvas size updates when window resizes */
window.addEventListener('resize', () => {
  overlay.width = video.videoWidth || overlay.clientWidth;
  overlay.height = video.videoHeight || overlay.clientHeight;
});
</script>
</body>
</html>
